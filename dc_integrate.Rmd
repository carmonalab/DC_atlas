---
title: "Integrate DC datasets"
author: "Massimo Andreatta & Santiago Carmona"
#output: html_notebook
---

```{r}
renv::restore()
```

Libraries
```{r}
#remotes::install_github('carmonalab/UCell')
#remotes::install_github('carmonalab/STACAS')
#remotes::install_github('carmonalab/ProjecTILs')

library(ggplot2)
library(Seurat)
library(tidyr)
library(SeuratObject)
library(Matrix)
library(patchwork)
library(remotes)
library(UCell)
library(STACAS)
```

#NB: for conversion between Scanpy format to matrix files, see export_data.py script

Read in data as Seurat objects (see dc_analysis.Rmd for data conversion)
```{r}
pdir <- "~/Dropbox/CSI/Datasets/Gerhard_JEM"

seurat.list <- readRDS(sprintf("%s/Gerhard_metanalysis_seuratlist.DC.anno.rds",pdir))

#Exclude Brown dataset
seurat.list <- seurat.list[names(seurat.list) != "brownSpleen"]

#only tumor samples
#seurat.list <- seurat.list[(c("qian","qianbc","qiancrc","qianlung","qianovarian","maier","zhang","zhangcrc","zilionis"))]
```

See batch effects
```{r fig.height=3}
merged <- Reduce(merge, seurat.list)

merged <- FindVariableFeatures(merged, nfeatures = 1000)
merged <- merged %>% ScaleData() %>% RunPCA(npcs=30) %>% RunUMAP(dims=1:30)

library(RColorBrewer)
palette <- brewer.pal(n=5, name="Set3")
names(palette) <- c("cDC1","cDC2","DC3","pDC","Multi")

#palette <- brewer.pal(n=6, name="Set3")
#names(palette) <- c("cDC1","cDC2","DC3","pDC","MoDC","Multi")


p1 <- DimPlot(merged, reduction="umap", group.by="Study") + theme(aspect.ratio = 1)
p2 <- DimPlot(merged, reduction="umap", group.by="scGate_multi", cols=palette) + theme(aspect.ratio = 1)
p1 | p2

ggsave("plots/Gerhard_sets_preintegration.pdf", height = 5, width=10)
```

Find anchors
```{r}
nfeatures=2000
ndim=40
set.seed(1234)
stacas_anchors <- FindAnchors.STACAS(seurat.list, 
                                     anchor.features = nfeatures,
                                     dims = 1:ndim)
```

```{r}
tree <- SampleTree.STACAS(stacas_anchors,
                          obj.names = names(seurat.list),
                          hclust.method = "ward.D")
```

Integrate data
```{r}
object_integrated <- IntegrateData.STACAS(stacas_anchors,
                                          sample.tree=tree,
                                              dims=1:ndim)
```

Dimred
```{r}
VariableFeatures(object_integrated) <- stacas_anchors@anchor.features 
object_integrated <- object_integrated %>% ScaleData() %>% RunPCA(npcs=ndim) %>% RunUMAP(dims=1:ndim)
```

```{r fig.height=3}
library(RColorBrewer)
palette <- brewer.pal(n=5, name="Set3")
names(palette) <- c("cDC1","cDC2","DC3","pDC","Multi")

#palette <- brewer.pal(n=6, name="Set3")
#names(palette) <- c("cDC1","cDC2","DC3","pDC","MoDC","Multi")


p1 <- DimPlot(object_integrated, reduction="umap", group.by="Study") + theme(aspect.ratio = 1)
p2 <- DimPlot(object_integrated, reduction="umap", group.by="scGate_multi", cols=palette) + theme(aspect.ratio = 1)
p1 | p2

ggsave("plots/Gerhard_sets_STACAS_unsup.pdf", height = 5, width=10)
```


Unsupervised clustering
```{r}
k.param <- 20
res <- 0.2

object_integrated <- FindNeighbors(object_integrated, k.param=k.param, dims=1:ndim)
object_integrated <- FindClusters(object_integrated, resolution = res, graph.name = "integrated_snn")

DimPlot(object_integrated, reduction = "umap", group.by="seurat_clusters") + theme(aspect.ratio = 1)
```

Find markers for unsupervised clusters
```{r}
Idents(object_integrated) <- "seurat_clusters"
DefaultAssay(object_integrated) <- "RNA"

set.seed(1234)
cluster.markers <- FindAllMarkers(object_integrated, only.pos = T, min.pct = 0.1, min.diff.pct=0.1, 
                                  logfc.threshold = 0.25, max.cells.per.ident = 500, test.use="wilcox",base=exp(1))

all <- cluster.markers |> dplyr::group_by(cluster) |> dplyr::top_n(n = 50, wt = abs(avg_logFC))

for (i in levels(object_integrated@active.ident)) {
    print(subset(all, cluster==i))
}  
DefaultAssay(object_integrated) <- "integrated"

```

Where are specific subtypes, e.g. the "DC5" by Villani et al.?
```{r fig.height=8, fig.align=14}
p <- list()
anns <- unique(object_integrated$state)

for (a in anns) {
p[[a]] <- DimPlot(object_integrated, reduction = "umap", cells.highlight = which(object_integrated$state == a)) + 
  theme(aspect.ratio = 1) + NoLegend() + ggtitle(a)
}

wrap_plots(p)
```

```{r fig.height=3}
DefaultAssay(object_integrated) <- "RNA"

FeaturePlot(object_integrated, features=c("CLEC10A","IL1R2","CD1C","CFP"))
FeaturePlot(object_integrated, features=c("C1QA","C1QB","C1QC","FCGR2A"))
FeaturePlot(object_integrated, features=c("CD1A","CD207","FCGBP","S100B"))
FeaturePlot(object_integrated, features=c("S100A8","S100A9","FCN1","CD14"))
FeaturePlot(object_integrated, features=c("S100B","ACY3","PRDM16","CD14"))
FeaturePlot(object_integrated, features=c("LTB","RUNX3","LTB","IL22RA2"))
FeaturePlot(object_integrated, features=c("PPP1R14A","DAB2","AXL","LILRA4"))
FeaturePlot(object_integrated, features=c("TRAC","CD2","CD3E","CD3D"))
```

Try to name clusters
```{r}
object_integrated$annotation <- NA
object_integrated$annotation[object_integrated$seurat_clusters %in% c("0")] <- "cDC2_CLEC10A"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("1","9")] <- "cDC1"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("2")] <- "DC3"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("3","7","10")] <- "cDC2_CD1A"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("4")] <- "MonoDC"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("5")] <- "pDC"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("6")] <- "Tcell_doublets"
object_integrated$annotation[object_integrated$seurat_clusters %in% c("8")] <- "AS-DC"

DimPlot(object_integrated, group.by = "annotation")
```

Make it into reference map
```{r}
library(ProjecTILs)

VariableFeatures(object_integrated) <- 
ref <- make.reference(object_integrated, assay = "integrated", recalculate.umap = TRUE,
                      annotation.column = "annotation", ndim = 40)

```


